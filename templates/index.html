<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
            /* Dropdown (ciclo): manter op√ß√µes leg√≠veis */
        select { color: #fff; }
        select option { background-color: rgba(15, 23, 42, 0.98); color: #fff; }
</style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">üí∞ Controle Financeiro</h1>
            <p class="text-purple-300">Gerencie suas finan√ßas com intelig√™ncia</p>
        </div>

        
        <!-- Filtro de Ciclo -->
        <div class="bg-white/5 backdrop-blur-lg rounded-xl p-4 mb-4 border border-white/10">
            <div class="flex flex-col md:flex-row gap-3 items-start md:items-center justify-between">
                <div class="flex gap-2 items-center">
                    <label class="text-sm text-purple-300">Ciclo:</label>
                    <select id="ciclo-select" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white min-w-[260px]" onchange="onChangeCiclo()"></select>
                </div>

                <div class="flex gap-2">
                    <button onclick="abrirModalCiclos()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg">
                        ‚öôÔ∏è Configurar Ciclo
                    </button>
                </div>
            </div>
        </div>

        <!-- Ciclo Info -->
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 border border-white/20">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-bold" id="ciclo-nome">Carregando...</h2>
                    <p class="text-sm text-purple-300" id="ciclo-periodo"></p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-purple-300">Or√ßamento</p>
                    <p class="text-3xl font-bold text-green-400" id="orcamento">R$ 0,00</p>
                </div>
            </div>
            <div class="w-full bg-white/20 rounded-full h-3 mb-2">
                <div id="progress-bar" class="h-3 rounded-full transition-all bg-green-500" style="width: 0%"></div>
            </div>
            <p class="text-sm text-purple-300" id="percent-usado">0% utilizado</p>
        </div>

        <!-- Storytelling -->
        <div class="bg-gradient-to-r from-purple-600/30 to-pink-600/30 backdrop-blur-lg rounded-xl p-6 mb-6 border border-purple-500/30">
            <h3 class="text-xl font-bold mb-2">üìñ Hist√≥ria do Ciclo</h3>
            <p class="text-lg mb-3" id="story-message">Carregando an√°lise...</p>
            <div id="story-insights" class="space-y-1 text-purple-200 text-sm"></div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
                <p class="text-xs text-purple-300">Gastos Totais</p>
                <p class="text-xl font-bold text-red-400" id="total-gastos">R$ 0,00</p>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
                <p class="text-xs text-purple-300">Dispon√≠vel</p>
                <p class="text-xl font-bold text-green-400" id="disponivel">R$ 0,00</p>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
                <p class="text-xs text-purple-300">Investimentos</p>
                <p class="text-xl font-bold text-blue-400" id="total-investimentos">R$ 0,00</p>
            </div>
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
                <p class="text-xs text-purple-300">Cart√µes</p>
                <p class="text-xl font-bold text-yellow-400" id="total-cartoes">R$ 0,00</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="showTab('dashboard')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-purple-600" data-tab="dashboard">Dashboard</button>
            <button onclick="showTab('fixed')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/10" data-tab="fixed">Fixos</button>
            <button onclick="showTab('transactions')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/10" data-tab="transactions">Lan√ßamentos</button>
            <button onclick="showTab('cards')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/10" data-tab="cards">Cart√µes</button>
            <button onclick="showTab('debts')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/10" data-tab="debts">D√≠vidas</button>
            <button onclick="showTab('checklist')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/10 hover:bg-white/20" data-tab="checklist">Checklist</button>
            <button onclick="showTab('investments')" class="tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/10" data-tab="investments">Investimentos</button>
        </div>

        <!-- Content Area -->
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
            <div id="content-area"></div>
        </div>

        <!-- Modals -->
        <div id="modal-container"></div>
    </div>

    <script>
        let cicloAtual = null;
        let ciclos = [];
        let cicloSelecionadoId = null;

        let modalMode = 'create'; // create | edit
        let editing = { type: null, id: null };
        let gastosFixos = [];
        let lancamentos = [];
        let investimentos = [];
        let cartoes = [];
        let dividas = [];
        let checklist = { fixos: [], lancamentos: [], cartoes: [], dividas: [] };

        // Carregar dados
        async function carregarDados() {
            try {
                // 1) Carrega lista de ciclos
                const ciclosRes = await fetch('/api/ciclos');
                ciclos = await ciclosRes.json();

                // Define ciclo selecionado (mant√©m sele√ß√£o; sen√£o usa ativo; sen√£o o primeiro)
                const ativo = ciclos.find(c => c.ativo);
                if (!cicloSelecionadoId) {
                    cicloSelecionadoId = ativo ? ativo.id : (ciclos[0]?.id ?? null);
                }

                renderCicloSelect();

                // Ciclo atual da interface √© o selecionado
                cicloAtual = ciclos.find(c => c.id === cicloSelecionadoId) || ativo;

                const [fixosRes, lancRes, invRes, cartRes, divRes, chkRes] = await Promise.all([
                    fetch(`/api/gastos-fixos?ciclo_id=${cicloSelecionadoId}`),
                    fetch(`/api/lancamentos?ciclo_id=${cicloSelecionadoId}`),
                    fetch('/api/investimentos'),
                    fetch('/api/cartoes'),
                    fetch('/api/dividas'),
                    fetch(`/api/checklist?ciclo_id=${cicloSelecionadoId}`)
                ]);

                gastosFixos = await fixosRes.json();
                lancamentos = await lancRes.json();
                investimentos = await invRes.json();
                cartoes = await cartRes.json();
                dividas = await divRes.json();
                checklist = await chkRes.json();

                atualizarInterface();
} catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        function renderCicloSelect() {
            const sel = document.getElementById('ciclo-select');
            if (!sel) return;
            sel.innerHTML = ciclos.map(c => `
                <option value="${c.id}" ${c.id === cicloSelecionadoId ? 'selected' : ''}>
                    ${c.nome}${c.ativo ? ' (ativo)' : ''}
                </option>
            `).join('');
        }

        function onChangeCiclo() {
            cicloSelecionadoId = parseInt(document.getElementById('ciclo-select').value, 10);
            carregarDados();
        }
        function atualizarInterface() {
            // Atualizar ciclo
            document.getElementById('ciclo-nome').textContent = cicloAtual.nome;
            document.getElementById('ciclo-periodo').textContent = `${cicloAtual.data_inicio} at√© ${cicloAtual.data_fim}`;
            document.getElementById('orcamento').textContent = `R$ ${cicloAtual.orcamento.toFixed(2)}`;

            // Calcular totais
            const totalFixosDebito = gastosFixos.filter(g => (g.forma_pgto || 'Debito') !== 'Credito').reduce((sum, g) => sum + g.valor, 0);
            const totalFixosCredito = gastosFixos.filter(g => (g.forma_pgto || 'Debito') === 'Credito').reduce((sum, g) => sum + g.valor, 0);
            const totalLancamentosDebito = lancamentos.filter(l => (l.forma_pgto || 'Debito') !== 'Credito').reduce((sum, l) => sum + l.valor, 0);
            const totalLancamentosCredito = lancamentos.filter(l => (l.forma_pgto || 'Debito') === 'Credito').reduce((sum, l) => sum + l.valor, 0);
            const totalInv = investimentos.reduce((sum, i) => sum + i.valor, 0);
            const totalCart = cartoes.reduce((sum, c) => sum + c.valor_atual, 0);
            const totalGastos = totalFixosDebito + totalLancamentosDebito + totalCart;
            const disponivel = cicloAtual.orcamento - totalGastos;
            const percentUsado = (totalGastos / cicloAtual.orcamento) * 100;

            // Atualizar stats
            document.getElementById('total-gastos').textContent = `R$ ${totalGastos.toFixed(2)}`;
            document.getElementById('disponivel').textContent = `R$ ${disponivel.toFixed(2)}`;
            document.getElementById('total-investimentos').textContent = `R$ ${totalInv.toFixed(2)}`;
            document.getElementById('total-cartoes').textContent = `R$ ${totalCart.toFixed(2)}`;
            document.getElementById('percent-usado').textContent = `${percentUsado.toFixed(1)}% utilizado`;

            // Atualizar barra de progresso
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${Math.min(percentUsado, 100)}%`;
            progressBar.className = `h-3 rounded-full transition-all ${
                percentUsado > 90 ? 'bg-red-500' : percentUsado > 70 ? 'bg-yellow-500' : 'bg-green-500'
            }`;

            // Storytelling
            const status = percentUsado > 90 ? 'cr√≠tica' : percentUsado > 70 ? 'aten√ß√£o' : 'saud√°vel';
            const messages = {
                cr√≠tica: `‚ö†Ô∏è Aten√ß√£o! Voc√™ j√° utilizou ${percentUsado.toFixed(1)}% do or√ßamento.`,
                aten√ß√£o: `üìä Seus gastos est√£o em ${percentUsado.toFixed(1)}% do or√ßamento.`,
                saud√°vel: `‚úÖ √ìtimo! Usando apenas ${percentUsado.toFixed(1)}% do or√ßamento.`
            };

            document.getElementById('story-message').textContent = messages[status];

            const lancamentosDebito = lancamentos.filter(l => (l.forma_pgto || 'Debito') !== 'Credito');
            const categoryTotals = lancamentosDebito.reduce((acc, l) => {
                acc[l.categoria] = (acc[l.categoria] || 0) + l.valor;
                return acc;
            }, {});
            const topCat = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];

            const insights = [
                `üí∞ Dispon√≠vel: R$ ${disponivel.toFixed(2)}`,
                `üìå Fixos (d√©bito): R$ ${totalFixosDebito.toFixed(2)}${totalFixosCredito > 0 ? ` ‚Ä¢ cr√©dito: R$ ${totalFixosCredito.toFixed(2)}` : ''}`,
                `üßæ Vari√°veis (d√©bito): R$ ${totalLancamentosDebito.toFixed(2)}${totalLancamentosCredito > 0 ? ` ‚Ä¢ cr√©dito: R$ ${totalLancamentosCredito.toFixed(2)}` : ''}`,
                topCat ? `üéØ Maior gasto: ${topCat[0]} (R$ ${topCat[1].toFixed(2)})` : '',
                totalInv > 0 ? `üìà Investido: R$ ${totalInv.toFixed(2)}` : '‚ö° Comece a investir!',
                totalCart > 0 ? `üí≥ Cart√µes: R$ ${totalCart.toFixed(2)}` : ''
            ].filter(Boolean);

            document.getElementById('story-insights').innerHTML = insights.map(i => `<p>${i}</p>`).join('');

            // Atualizar tab ativa
            const activeTab = document.querySelector('.tab-btn.bg-purple-600');
            if (activeTab) {
                showTab(activeTab.dataset.tab);
            }
        }

        function abrirModalCreate(tipo){
            modalMode = 'create';
            editing = { type: null, id: null };
            abrirModal(tipo, null);
        }

        function showTab(tab) {
            // Atualizar bot√µes
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = `tab-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap ${
                    btn.dataset.tab === tab ? 'bg-purple-600' : 'bg-white/10 hover:bg-white/20'
                }`;
            });

            const content = document.getElementById('content-area');
            
            if (tab === 'dashboard') {
                content.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Resumo Geral</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white/5 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">Gastos Fixos</h4>
                            ${gastosFixos.slice(0, 3).map(g => `
                                <div class="flex justify-between py-2 border-b border-white/10">
                                    <span class="text-sm">${g.nome}</span>
                                    <span class="text-sm font-semibold">R$ ${g.valor.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-white/5 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">√öltimos Lan√ßamentos</h4>
                            ${lancamentos.slice(0, 3).map(l => `
                                <div class="flex justify-between py-2 border-b border-white/10">
                                    <span class="text-sm">${l.descricao}</span>
                                    <span class="text-sm font-semibold">R$ ${l.valor.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (tab === 'fixed') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Gastos Fixos</h3>
                        <button onclick="abrirModalCreate('fixed')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Adicionar</button>
                    </div>
                    <div class="space-y-3">
                        ${gastosFixos.map(g => `
                            <div class="flex justify-between items-center bg-white/5 p-4 rounded-lg">
                                <div>
                                    <p class="font-semibold">${g.nome}</p>
                                    <p class="text-sm text-purple-300">${g.categoria} ‚Ä¢ <span class="text-xs px-2 py-0.5 rounded bg-white/10 border border-white/10">${(g.forma_pgto || "Debito")}</span></p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="text-lg font-bold text-red-400">R$ ${g.valor.toFixed(2)}</p>
                                    <button onclick="editarItem('fixed', ${g.id})" class="text-purple-300 hover:text-purple-200">‚úèÔ∏è</button>
                                    <button onclick="deletarItem('fixed', ${g.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (tab === 'transactions') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Lan√ßamentos</h3>
                        <button onclick="abrirModalCreate('transaction')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Adicionar</button>
                    </div>
                    <div class="space-y-3">
                        ${lancamentos.map(l => `
                            <div class="flex justify-between items-center bg-white/5 p-4 rounded-lg">
                                <div>
                                    <p class="font-semibold">${l.descricao}</p>
                                    <p class="text-sm text-purple-300">${l.categoria} ‚Ä¢ <span class="text-xs px-2 py-0.5 rounded bg-white/10 border border-white/10">${(l.forma_pgto || "Debito")}</span> - ${l.data}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="text-lg font-bold text-red-400">R$ ${l.valor.toFixed(2)}</p>
                                    <button onclick="editarItem('transaction', ${l.id})" class="text-purple-300 hover:text-purple-200">‚úèÔ∏è</button>
                                    <button onclick="deletarItem('transaction', ${l.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (tab === 'cards') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Cart√µes de Cr√©dito</h3>
                        <button onclick="abrirModalCreate('card')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Adicionar</button>
                    </div>
                    <div class="space-y-3">
                        ${cartoes.map(c => {
                            const pct = (c.valor_atual / c.limite) * 100;
                            return `
                                <div class="bg-white/5 p-4 rounded-lg">
                                    <div class="flex justify-between mb-3">
                                        <div>
                                            <p class="font-semibold">${c.nome}</p>
                                            <p class="text-sm text-purple-300">Venc: ${c.data_vencimento}</p>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <button onclick="editarItem('card', ${c.id})" class="text-purple-300 hover:text-purple-200">‚úèÔ∏è</button>
                                            <button onclick="deletarItem('card', ${c.id})" class="text-red-400">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>R$ ${c.valor_atual.toFixed(2)}</span>
                                        <span>R$ ${c.limite.toFixed(2)}</span>
                                    </div>
                                    <div class="w-full bg-white/20 rounded-full h-2">
                                        <div class="h-2 rounded-full ${pct > 80 ? 'bg-red-500' : 'bg-yellow-500'}" style="width: ${Math.min(pct, 100)}%"></div>
                                    </div>
                                    <p class="text-xs text-purple-300 mt-1">${pct.toFixed(1)}% do limite</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tab === 'debts') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">D√≠vidas</h3>
                        <button onclick="abrirModalCreate('debt')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Adicionar</button>
                    </div>
                    <div class="space-y-3">
                        ${dividas.map(d => `
                            <div class="bg-white/5 p-4 rounded-lg flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <p class="font-semibold">${d.nome}</p>
                                    <p class="text-sm text-purple-300">${d.tipo} ‚Ä¢ ${d.status}</p>
                                    <p class="text-xs text-white/80 mt-1">Parcelas: ${d.parcela_atual ?? d.parcelas_pagas ?? 0}${(d.total_parcelas_ajustada ?? d.total_parcelas) ? '/' + (d.total_parcelas_ajustada ?? d.total_parcelas) : ''}${(d.faltam !== null && d.faltam !== undefined) ? ' (faltam ' + d.faltam + ')' : ''}${d.proxima_parcela ? ' ‚Ä¢ Pr√≥xima: ' + d.proxima_parcela : ''}</p>
                                    <p class="text-xs text-white/70">
                                        ${d.parcela_mensal ? `Parcela: R$ ${Number(d.parcela_mensal).toFixed(2)} ‚Ä¢ ` : ''}
                                        ${d.taxa_mensal ? `Taxa: ${Number(d.taxa_mensal).toFixed(2)}% a.m. ‚Ä¢ ` : ''}
                                        ${d.data_inicio ? `In√≠cio: ${d.data_inicio} ‚Ä¢ ` : ''}
                                        Fim estimado: ${d.data_fim_estimado_atual || '-'}
                                    </p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="text-lg font-bold text-orange-300">R$ ${Number(d.saldo_atual || 0).toFixed(2)}</p>
                                    <button onclick="editarItem('debt', ${d.id})" class="text-purple-300 hover:text-purple-200">‚úèÔ∏è</button>
                                    <button onclick="deletarItem('debt', ${d.id})" class="text-red-400">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                        ${dividas.length === 0 ? `<p class="text-white/70">Nenhuma d√≠vida cadastrada.</p>` : ''}
                    </div>
                `;
            } else if (tab === 'checklist') {
                const fmt = (v) => (v === null || v === undefined) ? '' : v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                const renderItem = (it) => `
                    <label class="flex items-center justify-between gap-4 p-3 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15 transition">
                        <div class="flex items-start gap-3">
                            <input type="checkbox"
                                   class="mt-1 h-5 w-5 accent-[#a855ff]"
                                   ${it.checked ? 'checked' : ''}
                                   onchange="toggleChecklist('${it.tipo}', ${it.ref_id}, this.checked)">
                            <div>
                                <div class="font-semibold">${escapeHtml(it.titulo)} ${it.valor !== null ? `<span class="opacity-80">(${fmt(it.valor)})</span>` : ''}</div>
                                <div class="text-sm opacity-70">${escapeHtml(it.subtitulo || '')}</div>
                            </div>
                        </div>
                    </label>
                `;

                content.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-2xl font-bold">Checklist de Pagamentos</h2>
                                <p class="opacity-80 mt-1">Marque o que j√° foi pago no ciclo selecionado. Isso n√£o altera os valores das outras abas.</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="p-4 rounded-2xl bg-white/5 border border-white/10">
                                <h3 class="text-lg font-bold mb-3">Fixos (D√©bito/Pix)</h3>
                                <div class="space-y-2">
                                    ${(checklist.fixos || []).length ? (checklist.fixos || []).map(renderItem).join('') : '<div class="opacity-70">Sem itens.</div>'}
                                </div>
                            </div>

                            <div class="p-4 rounded-2xl bg-white/5 border border-white/10">
                                <h3 class="text-lg font-bold mb-3">Lan√ßamentos (D√©bito/Pix)</h3>
                                <div class="space-y-2">
                                    ${(checklist.lancamentos || []).length ? (checklist.lancamentos || []).map(renderItem).join('') : '<div class="opacity-70">Sem itens.</div>'}
                                </div>
                            </div>

                            <div class="p-4 rounded-2xl bg-white/5 border border-white/10">
                                <h3 class="text-lg font-bold mb-3">Cart√µes</h3>
                                <div class="space-y-2">
                                    ${(checklist.cartoes || []).length ? (checklist.cartoes || []).map(renderItem).join('') : '<div class="opacity-70">Sem itens.</div>'}
                                </div>
                            </div>

                            <div class="p-4 rounded-2xl bg-white/5 border border-white/10">
                                <h3 class="text-lg font-bold mb-3">D√≠vidas</h3>
                                <div class="space-y-2">
                                    ${(checklist.dividas || []).length ? (checklist.dividas || []).map(renderItem).join('') : '<div class="opacity-70">Sem itens.</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tab === 'investments') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Investimentos</h3>
                        <button onclick="abrirModalCreate('investment')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Adicionar</button>
                    </div>
                    <div class="space-y-3">
                        ${investimentos.map(i => `
                            <div class="flex justify-between items-center bg-white/5 p-4 rounded-lg">
                                <div>
                                    <p class="font-semibold">${i.nome}</p>
                                    <p class="text-sm text-purple-300">${i.tipo}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="text-lg font-bold text-green-400">R$ ${i.valor.toFixed(2)}</p>
                                    <button onclick="editarItem('investment', ${i.id})" class="text-purple-300 hover:text-purple-200">‚úèÔ∏è</button>
                                    <button onclick="deletarItem('investment', ${i.id})" class="text-red-400">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function abrirModal(tipo, item=null) {
            let formHtml = '';
            
            if (tipo === 'fixed') {
                formHtml = `
                    <input type="text" id="input-nome" placeholder="Nome" value="${item?.nome || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-valor" placeholder="Valor" step="0.01" value="${item?.valor ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="text" id="input-categoria" placeholder="Categoria" value="${item?.categoria || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <select id="input-forma-pgto" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-4 text-white">
                        <option value="Debito" ${(item?.forma_pgto || 'Debito') === 'Debito' ? 'selected' : ''}>D√©bito / Pix</option>
                        <option value="Credito" ${(item?.forma_pgto || 'Debito') === 'Credito' ? 'selected' : ''}>Cr√©dito (cart√£o)</option>
                    </select>

                    <div class="bg-white/5 p-3 rounded-lg mb-3">
                        <p class="text-sm text-purple-200 mb-2">Vincular a d√≠vida (opcional)</p>
                        <select id="input-divida-id" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                            <option value="">-- Sem v√≠nculo com d√≠vida --</option>
                            ${dividas.map(d => `<option value="${d.id}" ${(Number(item?.divida_id) === d.id) ? 'selected' : ''}>${d.nome}</option>`).join('')}
                        </select>
                        <input type="number" id="input-parcela-num" placeholder="Parcela paga (ex: 26)" step="1" value="${item?.parcela_num ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white">
                        <label class="flex items-center gap-2 mt-3 text-sm text-white/80">
                            <input type="checkbox" id="input-ultima-parcela" ${item?.ultima_parcela ? 'checked' : ''} />
                            Pagamento da √∫ltima parcela (antecipa√ß√£o)
                        </label>
                        <p class="text-xs text-white/60 mt-2">Se selecionar uma d√≠vida, preencha a parcela paga.</p>
                    </div>

                `;
            } else if (tipo === 'transaction') {
                formHtml = `
                    <input type="date" id="input-data" value="${item?.data || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="text" id="input-descricao" placeholder="Descri√ß√£o" value="${item?.descricao || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-valor" placeholder="Valor" step="0.01" value="${item?.valor ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="text" id="input-categoria" placeholder="Categoria" value="${item?.categoria || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <select id="input-forma-pgto-trans" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-4 text-white">
                        <option value="Debito" ${(item?.forma_pgto || 'Debito') === 'Debito' ? 'selected' : ''}>D√©bito / Pix</option>
                        <option value="Credito" ${(item?.forma_pgto || 'Debito') === 'Credito' ? 'selected' : ''}>Cr√©dito (cart√£o)</option>
                    </select>

                    <div class="bg-white/5 p-3 rounded-lg mb-3">
                        <p class="text-sm text-purple-200 mb-2">Vincular a d√≠vida (opcional)</p>
                        <select id="input-divida-id" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                            <option value="">-- Sem v√≠nculo com d√≠vida --</option>
                            ${dividas.map(d => `<option value="${d.id}" ${(Number(item?.divida_id) === d.id) ? 'selected' : ''}>${d.nome}</option>`).join('')}
                        </select>
                        <input type="number" id="input-parcela-num" placeholder="Parcela paga (ex: 26)" step="1" value="${item?.parcela_num ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white">
                        <label class="flex items-center gap-2 mt-3 text-sm text-white/80">
                            <input type="checkbox" id="input-ultima-parcela" ${item?.ultima_parcela ? 'checked' : ''} />
                            Pagamento da √∫ltima parcela (antecipa√ß√£o)
                        </label>
                        <p class="text-xs text-white/60 mt-2">Se selecionar uma d√≠vida, preencha a parcela paga.</p>
                    </div>

                `;
            } else if (tipo === 'investment') {
                formHtml = `
                    <input type="text" id="input-nome" placeholder="Nome" value="${item?.nome || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-valor" placeholder="Valor" step="0.01" value="${item?.valor ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="text" id="input-tipo" placeholder="Tipo" value="${item?.tipo || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-4 text-white">
                `;
            } else if (tipo === 'ciclo') {
                formHtml = `
                    <input type="text" id="input-nome" placeholder="Nome do Ciclo" value="${item?.nome || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="date" id="input-data-inicio" value="${item?.data_inicio || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="date" id="input-data-fim" value="${item?.data_fim || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-orcamento" placeholder="Or√ßamento" step="0.01" value="${item?.orcamento ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-4 text-white">
                `;
            } else if (tipo === 'debt') {
                formHtml = `
                    <input type="text" id="input-nome" placeholder="Nome (ex: Financiamento Carro)" value="${item?.nome || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="text" id="input-tipo" placeholder="Tipo (Financiamento, Empr√©stimo...)" value="${item?.tipo || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="number" id="input-saldo-inicial" placeholder="Saldo inicial" step="0.01" value="${item?.saldo_inicial ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                        <input type="number" id="input-saldo-atual" placeholder="Saldo atual" step="0.01" value="${item?.saldo_atual ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="number" id="input-total-parcelas" placeholder="Total de parcelas (ex: 48)" step="1" value="${item?.total_parcelas ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-parcela" placeholder="Parcela mensal (opcional)" step="0.01" value="${item?.parcela_mensal ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                        <input type="number" id="input-taxa" placeholder="Taxa mensal % (opcional)" step="0.01" value="${item?.taxa_mensal ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="date" id="input-inicio" value="${item?.data_inicio || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                        <input type="date" id="input-fim" value="${item?.data_fim_prevista || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    </div>
                    <select id="input-status" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-4 text-white">
                        <option value="Ativa" ${item?.status === 'Ativa' ? 'selected' : ''}>Ativa</option>
                        <option value="Quitada" ${item?.status === 'Quitada' ? 'selected' : ''}>Quitada</option>
                    </select>
                `;
            } else if (tipo === 'card') {
                formHtml = `
                    <input type="text" id="input-nome" placeholder="Nome do Cart√£o" value="${item?.nome || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-valor-atual" placeholder="Valor Atual" step="0.01" value="${item?.valor_atual ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="number" id="input-limite" placeholder="Limite" step="0.01" value="${item?.limite ?? ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-3 text-white">
                    <input type="date" id="input-vencimento" value="${item?.data_vencimento || ''}" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 mb-4 text-white">
                `;
            }

            document.getElementById('modal-container').innerHTML = `
                <div class="modal active fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onclick="fecharModal()">
                    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold mb-4">${modalMode === 'edit' ? 'Editar' : 'Adicionar'} ${tipo}</h3>
                        ${formHtml}
                        <div class="flex gap-3">
                            <button onclick="salvarItem('${tipo}')" class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold">${modalMode === 'edit' ? 'Salvar' : 'Adicionar'}</button>
                            <button onclick="fecharModal()" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-lg">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function editarItem(tipo, id) {
            modalMode = 'edit';
            editing = { type: tipo, id };
            let item = null;

            if (tipo === 'fixed') item = gastosFixos.find(x => x.id === id);
            if (tipo === 'transaction') item = lancamentos.find(x => x.id === id);
            if (tipo === 'investment') item = investimentos.find(x => x.id === id);
            if (tipo === 'card') item = cartoes.find(x => x.id === id);
            if (tipo === 'debt') item = dividas.find(x => x.id === id);
            if (tipo === 'ciclo') item = ciclos.find(x => x.id === id);

            abrirModal(tipo, item);
        }

        function fecharModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        async function salvarItem(tipo) {
            let endpoint = '';
            let data = {};
            let method = (modalMode === 'edit') ? 'PUT' : 'POST';

            if (tipo === 'fixed') {
                endpoint = '/api/gastos-fixos';
                data = {
                    nome: document.getElementById('input-nome').value,
                    valor: document.getElementById('input-valor').value,
                    categoria: document.getElementById('input-categoria').value,
                    forma_pgto: document.getElementById('input-forma-pgto') ? document.getElementById('input-forma-pgto').value : 'Debito',
                    ciclo_id: cicloSelecionadoId,
                };
            } else if (tipo === 'transaction') {
                endpoint = '/api/lancamentos';
                data = {
                    data: document.getElementById('input-data').value,
                    descricao: document.getElementById('input-descricao').value,
                    valor: document.getElementById('input-valor').value,
                    categoria: document.getElementById('input-categoria').value,
                    forma_pgto: (document.getElementById('input-forma-pgto-trans')?.value || 'Debito'),
                    divida_id: (document.getElementById('input-divida-id')?.value || ''),
                    parcela_num: (document.getElementById('input-parcela-num')?.value || ''),
                    ultima_parcela: (document.getElementById('input-ultima-parcela')?.checked ? 1 : 0)
                };
            } else if (tipo === 'investment') {
                endpoint = '/api/investimentos';
                data = {
                    nome: document.getElementById('input-nome').value,
                    valor: document.getElementById('input-valor').value,
                    tipo: document.getElementById('input-tipo').value
                };
            } else if (tipo === 'debt') {
                endpoint = '/api/dividas';
                data = {
                    nome: document.getElementById('input-nome').value,
                    tipo: document.getElementById('input-tipo').value,
                    saldo_inicial: document.getElementById('input-saldo-inicial').value,
                    saldo_atual: document.getElementById('input-saldo-atual').value,
                    parcela_mensal: document.getElementById('input-parcela').value,
                    taxa_mensal: document.getElementById('input-taxa').value,
                    data_inicio: document.getElementById('input-inicio').value,
                    data_fim_prevista: document.getElementById('input-fim').value,
                    total_parcelas: document.getElementById('input-total-parcelas').value,
                    status: document.getElementById('input-status').value
                };
            } else if (tipo === 'card') {
                endpoint = '/api/cartoes';
                data = {
                    nome: document.getElementById('input-nome').value,
                    valor_atual: document.getElementById('input-valor-atual').value,
                    limite: document.getElementById('input-limite').value,
                    data_vencimento: document.getElementById('input-vencimento').value
                };
            } else if (tipo === 'ciclo') {
                endpoint = (method === 'POST') ? '/api/ciclo' : '/api/ciclos';
                data = {
                    nome: document.getElementById('input-nome').value,
                    data_inicio: document.getElementById('input-data-inicio').value,
                    data_fim: document.getElementById('input-data-fim').value,
                    orcamento: document.getElementById('input-orcamento').value
                };
            }

            if (method === 'PUT') {
                endpoint = `${endpoint}/${editing.id}`;
            }

            try {
                const res = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const t = await res.text();
                    console.error('Erro API:', t);
                    try {
                        const j = JSON.parse(t);
                        alert(j.detail || j.error || 'Erro ao salvar item');
                    } catch {
                        alert('Erro ao salvar item');
                    }
                    return;
                }

                fecharModal();
                modalMode = 'create';
                editing = { type: null, id: null };

                await carregarDados();
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar item');
            }
        }

        async function deletarItem(tipo, id) {
            if (!confirm('Deseja realmente deletar este item?')) return;

            let endpoint = '';
            if (tipo === 'fixed') endpoint = `/api/gastos-fixos/${id}`;
            else if (tipo === 'transaction') endpoint = `/api/lancamentos/${id}`;
            else if (tipo === 'investment') endpoint = `/api/investimentos/${id}`;
            else if (tipo === 'card') endpoint = `/api/cartoes/${id}`;
            else if (tipo === 'debt') endpoint = `/api/dividas/${id}`;

            try {
                await fetch(endpoint, { method: 'DELETE' });
                await carregarDados();
            } catch (error) {
                console.error('Erro ao deletar:', error);
                alert('Erro ao deletar item');
            }
        }

        // Inicializar
        carregarDados();
    

        // Modal de configura√ß√£o de ciclos
        function abrirModalCiclos() {
            const rows = ciclos.map(c => `
                <div class="bg-white/5 p-3 rounded-lg flex flex-col md:flex-row md:items-center justify-between gap-2">
                    <div>
                        <p class="font-semibold">${c.nome} ${c.ativo ? '<span class="text-green-400">(ativo)</span>' : ''}</p>
                        <p class="text-sm text-purple-300">${c.data_inicio} at√© ${c.data_fim} ‚Ä¢ Or√ßamento: R$ ${Number(c.orcamento).toFixed(2)}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="ativarCiclo(${c.id})" class="bg-green-600/60 hover:bg-green-600 px-3 py-2 rounded-lg text-sm">Ativar</button>
                        <button onclick="editarItem('ciclo', ${c.id})" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-sm">Editar</button>
                        <button onclick="deletarCiclo(${c.id})" class="bg-red-600/60 hover:bg-red-600 px-3 py-2 rounded-lg text-sm">Deletar</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('modal-container').innerHTML = `
                <div class="modal active fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onclick="fecharModal()">
                    <div class="bg-slate-800 rounded-xl p-6 max-w-2xl w-full" onclick="event.stopPropagation()">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
                            <h3 class="text-xl font-bold">Configurar ciclos</h3>
                            <button onclick="abrirModalCreate('ciclo')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Novo ciclo</button>
                        </div>
                        <div class="space-y-3 max-h-[60vh] overflow-auto">
                            ${rows || '<p class="text-purple-200">Nenhum ciclo encontrado.</p>'}
                        </div>
                        <div class="mt-4">
                            <button onclick="fecharModal()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function ativarCiclo(id) {
            try {
                const res = await fetch(`/api/ciclos/${id}/ativar`, { method: 'POST' });
                if (!res.ok) throw new Error(await res.text());
                cicloSelecionadoId = id;
                await carregarDados();
            } catch (e) {
                console.error(e);
                alert('Erro ao ativar ciclo');
            }
        }

        async function deletarCiclo(id) {
            if (!confirm('Deletar este ciclo?')) return;
            try {
                const res = await fetch(`/api/ciclos/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(await res.text());
                cicloSelecionadoId = null;
                await carregarDados();
            } catch (e) {
                console.error(e);
                alert('Erro ao deletar ciclo');
            }
        }

        function escapeHtml(str){
            if(str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function recarregarChecklist(){
            if(!cicloSelecionadoId) return;
            const res = await fetch(`/api/checklist?ciclo_id=${cicloSelecionadoId}`);
            checklist = await res.json();
        }

        async function toggleChecklist(tipo, refId, isChecked){
            if(!cicloSelecionadoId) return;

            await fetch('/api/checklist', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ciclo_id: cicloSelecionadoId,
                    tipo: tipo,
                    ref_id: refId,
                    checked: isChecked ? 1 : 0
                })
            });

            // Atualiza estado local para n√£o precisar refetch
            const key = (tipo === 'fixed') ? 'fixos' :
                        (tipo === 'transaction') ? 'lancamentos' :
                        (tipo === 'card') ? 'cartoes' :
                        (tipo === 'debt') ? 'dividas' : null;

            if(key && checklist[key]){
                const it = checklist[key].find(x => x.ref_id === refId);
                if(it) it.checked = isChecked ? 1 : 0;
            }
        }

</script>
</body>
</html>